<html>
	<body>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script>
			var haveIndex = -1;
			function enter() {
			  if (event.keyCode == 13) {
				send();
				event.preventDefault();
			  }
			}
			function receive() {
				$.ajax({
					url: "/handler/receive",
					method: "POST",
					data: haveIndex.toString(),
					dataType: "json",
				}).then(function(data) {
				  print(data.message);
				  haveIndex = data.index;
				  receive();
				}).fail(function(xhr, message, error) {
				  print("RECEIVE FAILED.  Reload to resume.");
				});
			}
			function print(line) {
			  if (document.getElementById("chat").value) {
			  	document.getElementById("chat").value += "\n";
			  }
			  document.getElementById("chat").value += line;
			}
			function send() {
			  var value = document.getElementById("input").value;
			  document.getElementById("input").value = "";
			  $.ajax({
				url: "/handler/send",
				method: "POST",
				data: value,
				dataType: "text",
			  }).fail(function(xhr, status, error) {
				print("SEND FAILED: " + status + ": " + error)
			  });
			}
			$(document).ready(receive);
		</script>
		<h1>Chat 'em up</h1>
		<form method='POST' action='/handler/post'>
			<textarea id="chat" style="width: 100%; height: 10em"></textarea>
			Type: <input type='text' id='input' style="width: 100%" onkeydown="enter()"></input>
		</form>
	</body>
</html>
